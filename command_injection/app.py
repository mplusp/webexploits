import subprocess

import requests
from flask import Flask, render_template, render_template_string, request

app = Flask(__name__)


@app.route("/command_injection_1")
def command_injection_1():
    return render_template("command_injection_1.html", result="")


@app.route("/command_injection_1_fixed")
def command_injection_1_fixed():
    return render_template("command_injection_1_fixed.html", result="")


@app.route("/command_injection_1", methods=["POST"])
def command_injection_1_post():
    name = request.form["name"]
    # Pr체fe ob Input == Flag und sende POST falls ja
    if name == "123abc456def":
        requests.post(
            "http://main-website:3000/check-flag",
            data={
                "challenge_name": "cmd_inj_level-1",
                "challenge_flag": "123abc456def",
            },
        )
        return render_template(
            "command_injection_1.html",
            result="Gl체ckwunsch! Du hast die Challange gemeistert!",
        )
    # Lete Input an Subprocess weiter und stecke output in das Template
    try:
        result = subprocess.check_output(
            f"echo Hallo {name}, ich habe dich bereits erwartet.", shell=True
        )
        return render_template(
            "command_injection_1.html", result=result.decode("utf-8")
        )
    # Returne Template mit Error message
    except subprocess.CalledProcessError as e:
        print(e)
        return render_template(
            "command_injection_1.html", result="Dieser text existiert nicht."
        )
    # solution ;cat ~/passwordLVL1.txt #


@app.route("/command_injection_1_fixed", methods=["POST"])
def command_injection_1_post_fixed():
    return render_template(
        "command_injection_1_fixed.html",
        result=f"Hallo {request.form['name']}, ich habe dich bereits erwartet.",
    )


@app.route("/ssti_1")
def ssti_1():
    if request.args.get("hex"):
        val = request.args.get("hex")
        # Falls Input == Flag, sende POST
        if val == "abc123def456":
            requests.post(
                "http://main-website:3000/check-flag",
                data={
                    "challenge_name": "cmd_inj_level-2",
                    "challenge_flag": "abc123def456",
                },
            )
            return render_template(
                "ssti_1.html", result="Gl체ckwunsch! Du hast die Challenge bestanden!"
            )
        # Erkenne den Versuch einer SSTI und H채nge den Input an das verwendete Template
        if val.startswith("{{") and val.endswith("}}"):
            return render_template_string("{% include 'ssti_1.html' %}" + val)
        # Inputvalidierung
        if len(val) != 6:
            return render_template(
                "ssti_1.html", result="Der HEX-Wert muss aus genau 6 Zeichen bestehen."
            )
        else:
            for c in val:
                try:
                    int(c, 16)
                except ValueError:
                    return render_template(
                        "ssti_1.html",
                        result="Nur Zahlen von 0-9 und Buchstaben von A-F sind erlaubt.",
                    )
            # Wandle HEX zu RGB an
            r = int(val[:2], 16)
            g = int(val[2:4], 16)
            b = int(val[4:], 16)
            return render_template("ssti_1.html", result=f"R = {r}, G = {g}, B = {b}")

    else:
        return render_template("ssti_1.html", result="")

    # solution
    # hex={{url_for.__class__.__base__.__subclasses__()[84].load_module("os").popen("cat ~/passwordLVL2.txt").read()}}


@app.route("/ssti_1_fixed")
def ssti_1_fixed():
    if request.args.get("hex"):
        val = request.args.get("hex")
        # Inputvalidierung
        if len(val) != 6:
            return render_template(
                "ssti_1_fixed.html",
                result="Der HEX-Wert muss aus genau 6 Zeichen bestehen.",
            )
        else:
            for c in val:
                try:
                    int(c, 16)
                except ValueError:
                    return render_template(
                        "ssti_1_fixed.html",
                        result="Nur Zahlen von 0-9 und Buchstaben von A-F sind erlaubt.",
                    )
            # Wandle Hex -> RGB
            r = int(val[:2], 16)
            g = int(val[2:4], 16)
            b = int(val[4:], 16)
            return render_template(
                "ssti_1_fixed.html", result=f"R = {r}, G = {g}, B = {b}"
            )

    else:
        return render_template("ssti_1_fixed.html", result="")


@app.route("/einfuehrung_in_command_injection")
def einfuehrung_in_command_injection():
    return render_template("einfuehrung_cmd_inj.html")


@app.route("/einfuehrung_in_ssti")
def einfuehrung_in_ssti():
    return render_template("einfuehrung_ssti.html")


if __name__ == "__main__":
    app.run(host="0.0.0.0")
