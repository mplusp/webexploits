"use strict";
const express = require("express");
const app = express();
const path = require("path");

// process environment variables
const main_website_url = process.env.MAIN_WEBSITE_URL || "http://localhost";
const main_website_port = process.env.MAIN_WEBSITE_PORT || 80;

const path_traversal_url = process.env.PATH_TRAVERSAL_URL || "http://localhost";
const path_traversal_port = process.env.PATH_TRAVERSAL_PORT || 3000;

const command_injection_url =
  process.env.COMMAND_INJECTION_URL || "http://localhost";
const command_injection_port = process.env.COMMAND_INJECTION_PORT || 5000;
const command_injection_path =
  process.env.COMMAND_INJECTION_PATH || "command_injection_1";

const sql_injection_url = process.env.SQL_INJECTION_URL || "http://localhost";
const sql_injection_port = process.env.SQL_INJECTION_PORT || 5000;

// database
const sqlite3 = require("sqlite3").verbose();
const db_file = path.join(__dirname, "db", "progress.db");
const db = new sqlite3.Database(db_file, (err) => {
  if (err) {
    return console.error(err.message);
  }
  console.log(`Successful connection to the database ${db_file}`);
  return db;
});

// setup express app
app.set("view engine", "ejs");

app.use(
  "/bootstrap",
  express.static(path.join(__dirname, "/node_modules/bootstrap/dist"))
);
app.use("/css", express.static(path.join(__dirname, "/css")));
app.use("/js", express.static(path.join(__dirname, "/js")));
app.use("/assets", express.static(path.join(__dirname, "/assets")));

// routing
app.get("/", (req, res) => {
  res.render("index", {
    main_website_url,
    main_website_port,
    path_traversal_url,
    path_traversal_port,
    command_injection_url,
    command_injection_port,
    command_injection_path,
    sql_injection_url,
    sql_injection_port,
  });
});

app.post("/check-flag", (req, res) => {
  const challenge = req.query.challenge;
  const level = req.query.level;
  const flag = req.query.flag;

  _check_flag(challenge, level, flag, (result) => {
    console.log("result:", result);
    
    const statement = `UPDATE challenge_progress
    SET is_challenge_level_solved = ?
    WHERE challenge_name = ? AND challenge_level = ?;`;
    const statement_params = [result, challenge, level];

    db.run(statement, statement_params, (err) => {
      if (err) {
        console.log(err.message);
      }
      console.log("executed ", statement, "with", statement_params);
    });
    res.send({ challenge, level, flag, result });
  });
});

// start server
app.listen(3000, () => {
  console.log(
    new Date().toISOString(),
    "Node server running @",
    `${main_website_url}:${main_website_port}`
  );
});

// utility functions
const _check_flag = (challenge, level, flag, callback) => {
  console.table({ challenge, level, flag });

  const query = `SELECT challenge_level_flag FROM challenge_progress
  WHERE challenge_name = ? AND challenge_level = ?;`;
  const query_params = [challenge, level];

  db.get(query, query_params, (err, row) => {
    if (err) {
      console.log(err.message);
    }

    console.log("row:", row);

    if (flag === row.challenge_level_flag) {
      callback(1);
    } else {
      callback(0);
    }
  });
};
