<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <base href="http://localhost:8026" />
    <link rel="stylesheet" href="/css/style.css">

</head>

<body>

    <form action="index.php" method="GET">
        <input type="checkbox" id="hint1" name="check" />
        <input type="checkbox" id="hint2" name="check" />
        <input type="checkbox" id="hint3" name="check" />
        <input type="checkbox" id="hint4" name="check" />
        <input type="checkbox" id="hint5" name="check" />
        <input type="checkbox" id="hint6" name="check" />
        <input type="checkbox" id="hint7" name="check" />
        <input type="checkbox" id="hint8" name="check" />

        <div class=" title">
            <div class="inhalt">
                <div style="margin: 10px 70px;font-size: 18px; position: absolute; float : left;"><a href="http://localhost">Startseite</a></div>
                <h1> WEB Exploitation</h1>
            </div>
        </div>

        <div class="box">
            <h1> SQL-Injection</h1>
            <ul>
                <li>
                    <a href="Einleitung/einleitung1.php"><span style="color :#0c2461; text-decoration:none;">Einleitung</span></a>
                </li>

                <li><button type="submit" name="stufe1"> Angreifbare Login Seite (1)</button>

                </li>
                <li>
                    <a href="challRepariert/chall1.php" style="text-decoration: none;"><span style="color :#0c2461;">Erste Challenge repariert</span></a>
                </li>
                <li><span style="color:#0c2461">Union-Injection (2)</span>
                    <label for="flag2" class="flag2">Union-Injection Union-Injection (2)</label>
                </li>
                <li>
                    <a href="challRepariert/chall2.php" style="text-decoration: none;"><span style="color:#0c2461">Zweite Challenge repariert</span></a>
                </li>
            </ul>
        </div>

        <div class="rahmen" style="width: 676px;margin: -300px 439px;">

            <div class="box">

                <div class="auswahl">
                    <?php

                    echo '<div ><strong><span style=" color:blue; font-size:16px;margin: 14px -170px;position: absolute;"">Challenge 2: Unberechtigter Datenzugriff </strong></div>';
                    echo "<br/>";
                    echo '<div style="color: black; text-align: left; margin: 15px 20px; font-size: 12px;position: absolute;  width: 670px;"><p > In dieser Challenge wird die Herausforderungen mit dem URL durchgeführt. Die Hinweise helfen dir alle Herausforderungen schrittweise bewältigen.<br><br> Nachdem du der richtige Umsatz berechnet hast, wird SQL-Injection Challenges erfolgreich abgeschlossen </p></div>';
                    echo '<div style="color: black; text-align: left; margin: -133px 203px; font-size: 14px;position: absolute;  width: 315px;"><strong style ="margin: 411px -186px; position: absolute;">1. Betimme die genaue Anzahl der Spalten in der Datenbank. </strong></div>';

                    echo '<div class ="hints" style="margin: 304px 60px;width:91px"> <label for="hint1" id="hinweis"class="begin">Hinweis 1.1</label>  </div>';
                    echo '<div class ="hints"style="margin: 304px 190px;width:91px"> <label for="hint2" id="hinweis"class="begin">Hinweis 1.2</label>  </div>';
                    echo '<div class ="hints"style="margin: 304px 320px;width:91px">  <label for="hint3" id="hinweis" class="begin">Hinweis 1.3</label>  </div>';
                    echo '<div class ="hints"style="width:91px;padding: 0px 15px;text-align: end;"> <label id="hinweis" for="hint4" class="begin" style="margin: 327px -88px;">Hinweis 2.1</label></div>';
                    echo '<div class ="hints"style="width:91px;padding: 0px 15px;text-align: end;"> <label id="hinweis" for="hint5" class="begin" style="margin: 327px 42px;">Hinweis 2.2</label></div>';
                    echo '<div class ="hints"style="width:91px;padding: 0px 15px;text-align: end;"> <label id="hinweis" for="hint6" class="begin" style="margin: 327px 172px;">Hinweis 2.3</label></div>';
                    echo '<div class ="hints"style="width:91px;padding: 0px 15px;text-align: end;"> <label id="hinweis" for="hint7" class="begin" style="margin: 400px -88px;">Hinweis 3.1</label></div>';
                    echo '<div class ="hints"style="width:91px;padding: 0px 15px;text-align: end;"> <label id="hinweis" for="hint8" class="begin" style="margin: 400px 42px;">Hinweis 3.2</label></div>';

                    include 'sql_conn.php';
                    $id = $_GET['id'];
                    $a = explode(' ', $id, 2);
                    $s = "SELECT * FROM Filiale $a[1]";

                    echo '<div style="color: black; text-align: left; margin: -133px 203px; font-size: 14px;position: absolute;  width: 315px;"><strong style ="margin: 484px -186px;position: absolute;">2. Suche nach anfälligen Spalten, die String enthält  </strong></div>';
                    echo '<div style="color: black; text-align: left; margin: -133px 203px; font-size: 14px;position: absolute;  width: 315px;"><strong style ="margin: 557px -186px;position: absolute;">3. Wie viele Umsätze haben die Filialen insgesamt gemacht? </strong></div>';

                    echo "<br><br>";
                    $resulti = mysqli_query($conn, $s) or trigger_error("Query Failed! SQL: $s - Error: ");

                    echo '<table width=\"35%\" border=\"1\" cellpadding=\"0\" cellspacing=\"2\" style="margin: -8px 21px;line-height: 19px;" ><tr><th>Filiale</th><th>Standort</th><th>Land</th></tr>';


                    while ($aus =  $resulti->fetch_object()) {
                        if ($aus->Filiale == 480 | $aus->Standort == 480 | $aus->Land == 480) {
                            echo '<strong style="color: green; font-size:15px;position: absolute;margin: 25px 29px;width: 373px;"> Herzlichen Glückwunsch!</strong> <span style="font-size:12px;margin: 52px -36px;position: absolute;width: 510px;">-- SQL-Injection Challenges wurden erfolgreich abgeschlossen.</span> ';
                            /*$curl = curl_init();
                            curl_setopt($curl, CURLOPT_URL, "http://main-website:3000/check-flag");
                            curl_setopt($curl, CURLOPT_POST, true);
                            curl_setopt($curl, CURLOPT_POSTFIELDS, "challenge_name=sql-injection_level-2&challenge_flag=480");
                            curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
                            $output = curl_exec($curl);
                            curl_close($curl);*/
                        }
                        echo " <tr>";
                        echo "<td align='center'>" . $aus->Filiale . "</td>";
                        echo "<td align='center'>"  . $aus->Standort . "</td>";
                        echo "<td align='center'>"  . $aus->Land . "</td>";
                        echo "<br />";
                    }

                    echo "</tr>";
                    echo "</table>";
                    echo "</br> ";
                    ?>
                </div>
            </div>
        </div>

        <div class="hints_u1"><span><strong> Hinweis 1.1:</strong> Wenn eine URL möglicherweise mit * ? * = * endet und mit einer Datenbank kommuniziert wird, dann kannst es ausnutzen. </br></br> - Um zu prüfen, ob die Website für SQL-Injection geeignet ist, füge einfach ein * ' * am Ende der Abfrage ein. Zum Beispiel:</br></br> <strong style="margin: 10px 95px;">http://localhost/index.php?id=5 ′</strong></span></div>
        <div class="hints_u2"><span> <strong>Hinweis 1.2:</strong> Wenn die Anfrage Fehlermeldung schickt, heißt diese Webseite SQL-Injection durchführbar. </br></br> - Um die genau Anzahl der Spalten zu finden, kannst du folgende Anfrage Ausführen: (n-> Nummer von Spalten) </br></br> <strong style="margin: 10px 25px;">http://localhost/index.php?id=5 ORDER BY * n * .</strong></span></div>
        <div class="hints_u3"><span> <strong>Hinweis 1.3:</strong> Wenn die Ausführung bei der n-te Spalte eine Fehlermeldung zeigt, heißt n-te Spalte überschritten. </span></div>
        <div class="hints_u4"><span> <strong>Hinweis 2.1:</strong> Wenn du exakte Anzahl der Spalten von vorheriger Aufgabe kennst, kannst du jetzt einfach aller anfälligen Spalten herausfinden. </br></br> Mit dem UNION Befehl kann man die Abfrage von zwei oder mehr SELECT’s kombinieren. Zum Beispiel: </br><strong> http://localhost/index.php?id=5 UNION SELECT spalten_name FROM tabelle2 </strong></span></div>
        <div class="hints_u5"><span> <strong>Hinweis 2.2:</strong> Name der Tabelle2 findest du von der Fehlermehldung beim Query. </span></div>
        <div class="hints_u6"><span> <strong>Hinweis 2.3:</strong> Wenn man UNION Operator nutzt, muss die Anzahl der Spalten in der Tabelle gleich sein. Ansonsten bekommst du Fehlermeldung. Folgende Operator kannst du fuer Ausfuerung nutzen: <br><br><strong>* NULL *:</strong> Täuscht eine leere Spalte vor <br> <strong>* , * :</strong> Trennen einer Spalte von einer anderen <br> <strong>* 'a' * :</strong> Überprüpfung einer anfälligen Spalte. </span></div>
        <div class="hints_u7"><span> <strong>Hinweis 3.1:</strong> Wenn du alle anfälligen Spalten gefunden hast, kannst du jetzt Daten aus anderen Tabellen abrufen.<br><br>-Mithilfe von MYSQL Aggregierte Funktionen und Gruppierung kannst du Daten zugreifen. Dazu gehören zum Beispiel:<br><br><strong>SUM(expr) : </strong> Funktion gibt die Summe eines Ausdrucks zurück<br><strong> COUNT(expr):</strong>Funktion gibt eine Anzahl von Nicht NULL Werten zurück<br><strong>GROUP_CONCAT(expr): </strong> Funktion gibt nicht NULL String Wert zurück </span></div>
        <div class="hints_u8"><span> <strong> Hinweis 3.2:</strong> * Zeichen wird allen Hinweisen um die Angaben zu trennen genutzt. </span></div>
        <a href="javascript:history.back()" style="margin:83px 853px;position: absolute;width: 225px;font-size: 13px;text-decoration: none;"> Zurück zur Challenge Seite</a>

    </form>

</body>

</html>