<!DOCTYPE html>
<html lang="en">
<title> SQL-Injection</title>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="http://localhost:8026" />
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>

    <form action="/challRepariert/chall1.php" method="POST">

        <input type="checkbox" id="checkbox" name="check_round1">
        <input type="checkbox" id="s2_solution" name="s2_solution" value="1">


        <div class=" title">
            <div class="inhalt">
                <div style="margin: 10px 70px;font-size: 18px; position: absolute; float : left;"><a href="http://localhost">Startseite</a></div>

                <h1> WEB Exploitation</h1>
            </div>
        </div>

        <div class="box">
            <h1> SQL-Injection</h1>
            <ul>
                <li>
                    <a href="Einleitung/einleitung1.php" style="text-decoration: none;"><span style="color :#0c2461;">Einleitung</span></a>
                </li>

                <li><a href="../index.php" style="text-decoration: none;"> <span style="color :#0c2461;">Anfreifbare Login Seite </span></a>

                </li>
                <li>
                    <a href="challRepariert/chall1.php" style="text-decoration: none;"><span style="color :#0c2461;">Erste Challenge repariert</span></a>
                </li>

            </ul>
        </div>

        <div class="rahmen" style="margin: -208px 440px;">

            <div class="box">

                <div class="auswahl">
                    <?php
                    getenv('MYSQL_DBHOST') ? $db_host = getenv('MYSQL_DBHOST') : $db_host = "localhost";
                    getenv('MYSQL_DBPORT') ? $db_port = getenv('MYSQL_DBPORT') : $db_port = "3306";
                    getenv('MYSQL_DBUSER') ? $db_user = getenv('MYSQL_DBUSER') : $db_user = "root";
                    getenv('MYSQL_DBPASS') ? $db_pass = getenv('MYSQL_DBPASS') : $db_pass = "";
                    getenv('MYSQL_DBNAME') ? $db_name = getenv('MYSQL_DBNAME') : $db_name = "test";
                    try {
                        $conn = new mysqli("$db_host:$db_port", $db_user, $db_pass, $db_name);
                    } catch (Exception $fehler) {
                        $fehler->getMessage();
                    }


                    echo '<div class = "chall1" style="color:blue;width: 555px;margin: 5px 60px;position: absolute; font-size:16px;"><strong>Challenge 1: Demonstration einer SQL-Injection-Sicherheitslücke </strong></div>';
                    echo "<br/> <br/>";
                    echo '<div style="color: black; text-align: left; margin: 20px 41px;font-size: 14px;float: left;position: absolute;width: 590px;"> Die erste Challenge soll man einloggen, ohne Passwort zu kennen. In dieser Seite erfahrst du, wie man die gleiche Challenge vor SQL-Injection geschützen kann.</br><br></div>';
                    echo "<div><span style=' margin: 85px -323px;font-size: 14px;float: left;position: absolute;width: 636px;'> Logge mit ausführbaren SQL-Injection Code <strong> admin' or 1='1 </strong> ein.</span>
                            </div> ";

                    echo '<div><label for="checkbox" class="begin" style="margin: 110px -216px;color: black;background: gainsboro;padding: 12px;">Einloggen</label>  </div>';

                    if (isset($_POST['login'])) {
                        $username = mysqli_real_escape_string($conn, $_POST['username']);
                        $password = mysqli_real_escape_string($conn, $_POST['password']);

                        echo '<br><br><br><br><br><br><br><br><br><br>';
                        $sql1 = "SELECT * FROM users  WHERE username ='$username'  AND password ='$password' ";

                        $sql = "SELECT * FROM users  WHERE username =?  AND password =? ";
                        $stmt = $conn->prepare($sql);
                        $stmt->bind_param("ss", $username, $password);
                        $stmt->execute();
                        $result = $stmt->get_result();
                        $result1 = mysqli_query($conn, $sql1);
                        echo "<br><br>";

                        $count = mysqli_fetch_array($result1);
                        echo '<strong style="margin: -26px 0px;position: absolute; font-size:18px"> Mögliche ergreifbare Schutzmaßnahme 1: </strong> ';
                        echo $sql1 . "<br><br>";

                        echo '<div style="color:teal;width: 657px;text-align: left;padding: 2px 21px;"> In diesem Fall werden die Nutzereingaben bereinigt. Diese Funktion entkommt Sonderzeichen in einem String für die SQL Anweisungen. <br><br>$username = mysqli_real_escape_string($connection, $Eingabe); <br></div>';
                        echo '<strong style="margin: 25px -256px;position: absolute; font-size:18px;"> Mögliche ergreifbare Schutzmaßnahme 2: </strong> <br><br><br>';
                        echo $sql . "<br><br>";
                        echo '<div style="color:teal;width: 652px;text-align: left;padding: 2px 21px;"> Die obige Schutzmaßnahme ist praktisch. Aber mit viel Bemühungen ist möglich trotz dieser Funktion die Datenbank angreifbar. Deswegen ist es wichtig eine sichere Schutzmaßnahme wie vorbereitete Anweisungen zu verwenden. <br></div>';
                        echo '<div><a href="../Einleitung/einleitung1.php/#massnahmen" style="color:gray;margin:30px 147px; position:absolute;font-size: 13px;width: 95px;"> Mehr ansehen</a>
                        </div> ';

                        echo '<a href="../index.php" style="margin:83px 53px;position: absolute;width: 225px;font-size: 16px;text-decoration: none;"> Zurück zur Challenge Seite</a>';
                        if ($result->num_rows != 0) {

                            echo '<table width=\"35%\" border=\"1\" cellpadding=\"0\" cellspacing=\"2\" style="margin: 15px 54px;" ><tr><th>Username</th><th>Password</th></tr>';
                            while ($row = $result->fetch_assoc()) {

                                echo " <tr>";
                                echo "<td align='center'>" .  $row['username']  . "</td>";
                                echo "<td align='center'>"  .  $row['password'] . "</td>";
                                echo "<br />";
                            }

                            echo "</tr>";
                            echo "</table>";
                            echo "</br> ";
                        }
                        if (isset($count)) {

                            while ($aus =  $result1->fetch_object()) {

                                echo " <tr>";
                                echo "<td align='center'>" . $aus->username . "</td>";
                                echo "<td align='center'>"  . $aus->password . "</td>";
                                echo "<br />";
                            }

                            echo "</tr>";
                            echo "</table>";
                            echo "</br> ";
                        } else {
                            echo '<div style="margin: -375px 234px;color: red;position: absolute;width: 375px;" ><h3> Ungültige Eingabe!</h3> </div>';
                        }
                    }

                    ?>


                </div>
            </div>
        </div>

        <div class="popup">

            <input type="submit" name="cancel" class="cancel" value="x">

            <label for="checkbox" class="cancel"> </label>
            <div class="round"> Stufe 1
            </div>
            <div class="inhalt"></div>
            <?php
            echo "Du kannst den Nutzernamen  admin verwenden. Finde heraus wie du dich ohne Password einloggen kannst. <br /> <br />";

            ?>

            <div class="name">
                <input type="text" name="username" placeholder="username" autocomplete="off">
                <input type="password" name="password" placeholder="Password">
            </div>
            <div class="btn">
                <input type="submit" name="login" value="submit">
            </div>

            <div class="hint">
                <ul>
                    <p>Hinweise:</p>
                    <li>
                        <div class="content">
                            <h3>Gültige Nutzerdaten sind:</h3>
                            <p> username - admin password - ad<br /> username - user password - ad </p>
                        </div>

                    </li>
                    <li>
                        <div class="content">
                            <h3> Boolescher Bedingungen Schlüsselwort OR </h3>
                            <p> 1=1 ist eine Anweisung, die immer den Wert true liefert. <br /> </p>
                        </div>

                    </li>
                    <li>
                        <div class="content">
                            <h3> # charactor</h3>
                            <p> Das Doppelkreuz (#) kommentieren den Rest der SQL-Anfrage aus.</p>
                        </div>
                    </li>
                    <li>
                        <div class="content">
                            <h3> Das Semikolon (;)</h3>
                            <p> Das Semikolon (;) beendet die SQL-Anweisung </p>
                        </div>

                    </li>

                </ul>
            </div>
        </div>
        </div>

    </form>

</body>

</html>