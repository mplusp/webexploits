<!DOCTYPE html>
<html lang="en">
<title> XSS-Injection</title>
<head>

    <link rel="stylesheet" href="Style.css">
</head>
<body>



<span id ="comment"><strong style="font-size:30px"> Comment</strong></span>
  <input type="checkbox" id="PersHint1" name="PersHint1">
  <input type="checkbox" id="PersHint2" name ="PersHint2">

<form action="xssPers.php" method="POST" >

<div style="color:blue;"> <?php echo " Subject ". "  ";?><input type="text" name="subject" value ="" style="margin: 10px 89px;width: 334px;"> <?php echo"<br>"?>
<p style="margin: -30px 700px;width: 500px;color: black;"><strong> Stufe 1: </strong> Füge eine Nachricht hinzu, die ein Popup mit diener Dokument Cookies anzeigt</p>
<input type="text" name="flag1" placeholder="Flag eingeben:" style="margin: 50px 700px;width: 300px;color: black;position:absolute;">
<input type="submit" name="sub_flag1" value="Submit" style="margin: 52px 1034px;color: green;position:absolute;">
</div>
<div><span  style="color:blue;margin: 35px 0px;position: absolute;">Nachricht</span><textarea name="text" style="margin: 30px 155px;height: 180px;width: 350px; resize: none;" ></textarea>
<p style="margin: -130px 700px;width: 500px;color: black;position:absolute;"><strong>Stufe 2: </strong> Ändere die Überschrift "Comment" als "Feedback", indem du neue Nachricht hinzufügst.</p>
<input type="text" name="flag2"  placeholder="Flag eingeben:" style="margin: 212px 36px;width: 300px;color: black;position:absolute;" >
<input type="submit" name="sub_flag2"   value="Submit" style="margin: 211px 365px;color: green;position:absolute;">

</div>
<div ><input type="submit" name="submit"  value="Comment" style="width: 356px;margin: -21px 154px;color: blue; position:absolute;"></div>
      <div class="PersHint_popup1"><p style="font-size: 15px;white-space: pre-wrap;margin: 85px 10px;"><strong> Um auf das HTML Element zugreifen zu können brauchst du HTML DOM (Document Object Model) Method. <br><br> -> document.getElementById("id") Method<br></strong> </p></div>
      <div class="PersHint_popup2"><p style="font-size: 15px;white-space: pre-wrap;margin: 85px 10px;"> <strong>Die Eigenschaft *innerHTML* ist nützlich, um den Inhalt von HTML-Elementen abzurufen oder zu ersetzen.<br><br> -> .innerHTML= "";</strong></p></div>
    
  </form>
<?php 
if(isset($_POST['flag1'])!="xssPers1_done"){
 //$_SESSION['stufe1_done'] = true;
 
echo"<input type='text'name='flag2' placeholder='Flag eingeben:' id ='disabled_text' disabled/>";
echo'<input type="submit" name="sub_flag2" value="Submit" style="margin: -31px 1029px;color: green;position:absolute;" disabled/>'; 
}


?>

<?php
echo'<label for="PersHint1" class="hint" id="aa" style="margin: -63px 723px;">Hinweis 1</label>';
echo'<label for="PersHint2" class="hint" id="bb" style="margin: -63px 853px;">Hinweis 2</label>';

?>

<form action="../index.php" method="POST">
<div class ="back" style="margin: 20px 699px;position: absolute;"><input type ="submit" name ="back2" value="Zurück"style="background: bottom;width: 94px;height: 40px;"></div> 
</form>
<?php
require("../sql_conn.php");

$subject = trim(htmlentities($_POST['subject']));
$comment = trim($_POST['text']);

$stufe1="<script>alert(document.cookie)</script>";
$stufe2 ='<script>document.getElementById("comment").innerHTML="Feedback";</script>';

if(isset($_POST['submit'])){

if(str_replace("<script>","",$comment)==false){ 
$comment= str_replace($comment,'',$comment);
}
else if($comment==$stufe1){
  $comment= str_replace($comment,$stufe1,$comment);
$Confirmation = "<script> window.confirm('Glückwünsch!  Flag fuer naechste Stufe: xssPers1_done');   </script>";
 if ($Confirmation == true) {
 echo $Confirmation;
}
} else if($comment==$stufe2){ 
$comment= str_replace($comment,$stufe2,$comment); 
$Confirmation = "<script> window.confirm('Glückwünsch! Letzte Flag : done_xssPers2');   </script>";
if ($Confirmation == true) {
 echo $Confirmation;
} 
}
else{
$pos = strpos($comment, "<script>");

if($pos!==false){
$comment=str_replace($comment,'',$comment);

//}else{
//$comment=str_replace($comment,$comment,$comment);} 
}
}
//else if(str_replace("<script>","",$comment)==true){

//$comment= str_replace($comment,'',$comment);
//}
if($_POST['text'] !=""){
$stmt = $conn->prepare("INSERT IGNORE INTO xss ( Subject,Comment) VALUES ( ?, ?) ");
$stmt->bind_param("ss", $subject, $comment);
$stmt->execute();
if($comment==$stufe1){
$id = mysqli_insert_id($conn);
}
}else{
echo "<br>"."Nachricht Schreiben!";}
}


$update = "UPDATE xss SET Comment='' WHERE id='$id'";

if ($conn->query($update) === false) {
  echo "Error updating record: ". $conn->error;
}

echo "<br>"; 
$show = $conn->query("SELECT * FROM xss ");

while($ausgabe=$show->fetch_object()){

echo'<div style="width: 651px;"> <div>';
echo "<br>"; 
echo '<span style ="color:red; font-size:13px;"> Subject: </span>' . $ausgabe->Subject. "<br>";
echo '<span style ="color:red; font-size:13px;"> Nachricht: </span>' .$ausgabe->Comment. "<br>";

} 

if ( $_POST['flag2']=="done_xssPers2" && isset($_POST['sub_flag2'])){
$sql = "DELETE from xss where id>3 ";

if ($conn->query($sql) === TRUE) {
  echo '<strong style="margin: -60px 722px;position: absolute;font-size: 17px;width:700px;color: green;">Herzlichen Glückwunsch! Du hast die SQL-Injection und XSS-Injection Challenges erfolgreich abgeschloßen  :)</strong>';
} else {
 
 echo "Error deleting record: " . $conn->error;
}

$conn->close();
}
?>
<body>
<html>
