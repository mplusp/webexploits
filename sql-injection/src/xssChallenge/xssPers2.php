<!DOCTYPE html>
<html lang="en">
<title> XSS-Injection</title>

<head>

    <link rel="stylesheet" href="styleVersion.css">
</head>

<body>


    <input type="checkbox" id="PersHint1" name="PersHint1">
    <input type="checkbox" id="PersHint2" name="PersHint2">
    <input type="checkbox" id="solution" name="s" />

    <div class=" title">
        <div style="margin: 3px 774px;font-size: 16px; position: absolute; "><a href="http://localhost"
                style="text-decoration: none;"> <span style="color :black; ">Home</span></a></div>
        <div style="margin: 5px 847px;font-size: 13px; position: absolute; width:145px;"><a
                href="http://localhost:5000/command_injection_1" style="text-decoration: none;"> <span
                    style="color :black; ">Command-Injection</span></a></div>
        <div style="margin: 5px 1000px;font-size: 13px; position: absolute; width:145px;"><a
                href="http://localhost:3000" style="text-decoration: none;"> <span
                    style="color :black; ">Path-Traversal</span></a></div>
        <div style="margin: 5px 1125px;font-size: 13px; position: absolute; width:145px;"><a
                href="http://localhost:8026" style="text-decoration: none;"> <span
                    style="color :black; ">SQL-Injection</span></a></div>
        <div style="margin: 5px 1230px;font-size: 13px; position: absolute; width:145px;"><a
                href="http://localhost:8026/xssMain.php" style="text-decoration: none;"> <span
                    style="color :black; ">XSS-Injection</span></a></div>

        <h1 style="padding: 2px 12px;font-size: 20px;"> Web-Exploitation-Demos
        </h1>
    </div>
    <br><br>
    <span id="comment"><strong style="font-size:30px;"> Kommentar</strong></span>
    <form action="xssPers2.php" method="POST">

        <div><span style="color:blue;margin: 45px 0px;position: absolute;">Nachricht</span><textarea name="text"
                style="margin: 30px 95px;height: 180px;width: 425px; resize: none;position:absolute;"></textarea> </div>

        <div><input type="submit" name="submit" value="kommentieren"
                style="width: 431px;margin: 220px 94px;color: blue; position:absolute;"></div>


    </form>

    <form action="../xssMain.php" method="POST">
        <div class="back" style="margin: 283px -3px;position: absolute;"><input type="submit" name="back"
                value="Zurück zur Challenge-Seite" style="background: none; "></div>
    </form>

    <div class="Rahmen" style="margin: 0px 595px;">

        <div class="r_innen">
            <div>
                <p style="color:blue; margin:10px 140px;position: absolute;"> Challenge 2: Demonstration einer
                    persistenten XSS-Injection </p>
            </div>
            <div>
                <p style="position: absolute;margin: 52px 40px;font-size: 14px;"> Diese Challenge ist aufeinander in
                    zwei
                    Stufen aufgebaut. Zu einer anderen Stufe zu gelangen, muss ein Code im Textfeld eingegeben
                    werden. Einen Code bekommst du, wenn du die jeweils vorherige Stufe gelöst hast.</p></br><br><br>
            </div>
            <div>
                <p style="margin: 50px 41px;font-size: 14px;"> Wenn du die zweite Stufe gelöst hast, wirst du
                    XSS-Injection
                    Challenges erfolgreich abschließen.</p>
            </div>
            <div
                style="margin: -35px 90px; background-color: #06f206bf;box-sizing: border-box;border-radius: 10px;width: 126px;height: 54px;position:absolute;">
                <a href="xssPers1.php" style=" color:black; margin: 17px 30px; position: absolute;"> Einfach</a>
            </div>
            <div
                style="margin: -35px 240px; background-color: #06f20659;box-sizing: border-box;border-radius: 10px;width: 126px;height: 54px;position:absolute;">
                <span style=" color:black;position:absolute; margin:17px 38px;">Mittel</span>
            </div>
            <div
                style="margin: -35px 390px; background-color: #898e863d;box-sizing: border-box;border-radius: 10px;width: 126px;height: 54px;position:absolute;">
                <label for="solution" style=" color:black;position:absolute; margin:17px 27px;">Lösungen</label>

                <div class="PersHint_popup1">
                    <p style="font-size: 15px;margin: 50px 10px;"><strong> Um auf das HTML Element
                            zugreifen zu können, <br> brauchst du HTML DOM (Document Object Model) Methode. <br><br> ->
                            document.getElementById("id") <br><br> id = id von "Kommentar"<br><br> id findest du, indem
                            du
                            CTRL+Shift+C- Taste drueckst.</strong> </p>
                </div>
                <div class="PersHint_popup2">
                    <p style="font-size: 15px;margin: 50px 10px;"> <strong>Die Eigenschaft
                            innerHTML ist nützlich, um den Inhalt von HTML-Elementen <br>abzurufen oder
                            zuersetzen.<br><br> -> .innerHTML= ""; <br><br>
                        </strong></p>
                </div>
                <div class="Pers_sol2">
                    <p style="font-size: 15px;margin: 45px 10px;"> Stufe 2: <br><br>
                        <?php $str = '<script>document.getElementById("comment").innerHTML="Feedback";</script>';
                        echo htmlentities($str); ?> <br><br>
                    </p>
                </div>
            </div>

        </div>

        <div style="background-color: #0000001a;height: 130px;margin: 220px 38px;width: 720px;position: absolute;">
            <div style="background-color: white;position: absolute;height: 110px;width: 700px;margin: 10px 10px;">
                <?php
                echo  '<span style="position: absolute;width: 690px;margin: 11px 8px;" ><strong> Stufe2:</strong>  Ändere die Überschrift "Kommentar" zu "Feedback", indem du einem neuen Nachricht hinzufügst. </span>' . "<br><br>";
                ?>
            </div>
        </div>
    </div>
    <div>
        <label for="PersHint1" class="hint" id="aa" style="margin: 298px 678px;">Hinweis 1</label>

        <label for="PersHint2" class="hint" id="bb" style="margin: 298px 811px;">Hinweis 2</label>
    </div>

    <?php
    include "sqlConn.php";

    $comment = trim($_POST['text']);

    $stufe2 = '<script>document.getElementById("comment").innerHTML="Feedback";</script>';

    if (isset($_POST['submit'])) {

        if (str_replace("<script>", "", $comment) == false) {
            $comment = str_replace($comment, '', $comment);
        } else if ($comment == $stufe2) {
            $curl = curl_init();
            curl_setopt($curl, CURLOPT_URL, "http://main-website:3000/check-flag");
            curl_setopt($curl, CURLOPT_POST, true);
            curl_setopt($curl, CURLOPT_POSTFIELDS, "challenge_name=XSS-injection_level-2&challenge_flag=done_Pers515");
            curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
            $output = curl_exec($curl);
            curl_close($curl);

            $comment = str_replace($comment, $stufe2, $comment);
            $Confirmation = "<script> window.confirm('Glückwünsch! ');   </script>";
            if ($Confirmation == true) {
                echo $Confirmation;
            }
            echo '<strong style="margin: 400px 650px;;position: absolute;font-size: 17px;width:700px;color: green;">Herzlichen Glückwunsch! Du hast die SQL-Injection und XSS-Injection Challenges erfolgreich abgeschlossen. </strong>';
            echo '<strong style="margin: 461px 650px;;position: absolute;font-size: 15px;width:700px;"> Lade Webseite neu oder drücken CTRL+Shift+R. XSS-Injection Code ist dauerhaft in der Datenbank gespeichert.</strong>';

            echo '<div style="margin: 149px 845px; background-color: #06f206bf;box-sizing: border-box;border-radius: 10px;width: 126px;height: 54px;position:absolute;">
            <span style=" color:black;position:absolute; margin:17px 38px;">Mittel</span> </div>';
        } else {
            $pos = strpos($comment, "<script>");

            if ($pos !== false) {
                $comment = str_replace($comment, '', $comment);
            }
        }

        if ($_POST['text'] != "") {
            $stmt = $conn->prepare("INSERT IGNORE INTO xss ( Comment) VALUES ( ?) ");
            $stmt->bind_param("s", $comment);
            $stmt->execute();
        } else {
            echo  "Nachricht Schreiben!";
        }
    }


    echo "<br>";

    $show = $conn->query("SELECT * FROM xss ");
    echo '<div style="height:290px;"></div>';

    while ($ausgabe = $show->fetch_object()) {

        echo '<div style="width: 550px;"> <div>';
        echo "<br>";
        echo '<span style ="color:red; font-size:13px;"> Nummer: </span>' . $ausgabe->id . "<br>";
        echo '<span style ="color:red; font-size:13px;"> Nachricht: </span>' . $ausgabe->Comment . "<br>";
    }
    if (isset($_POST['back'])) {
        $sql = "DELETE from xss where id>2 ";

        $conn->close();
    }
    ?>

    <body>
        <html>