import os
import subprocess

from flask import Flask, render_template, request, render_template_string, flash

app = Flask(__name__)


@app.route("/command_injection_1")
def command_injection_1():
    return render_template("command_injection_1.html")


@app.route("/command_injection_1", methods=["POST"])
def command_injection_1_post():
    name = request.form["name"]
    try:
        return subprocess.check_output(
            f"echo Hello {name}, I have been expecting you", shell=True
        )
    except subprocess.CalledProcessError as e:
        print(e)
        return "That text doesn't exist"
    # solution ;cat ~/passwordLVL1.txt #


@app.route("/command_injection_1_hint1", methods=["POST"])
def command_injection_1_hint1():
    if request.form["hint1"]:
        return "<p>Das Programm nutzt den echo Befehl, um den Namen in einen vorgefertigten Satzt einzubauen. <br>Vielleicht kann man ihn dazu bringen noch weitere Befehle auszuführen.</p>"


@app.route("/command_injection_1_hint2", methods=["POST"])
def command_injection_1_hint2():
    if request.form["hint2"]:
        return "<p>Man kann mittels ; mehrere Befehle voneinander trennen.</p>"


@app.route("/command_injection_1_hint3", methods=["POST"])
def command_injection_1_hint3():
    if request.form["hint3"]:
        return "<p>Um den Inhalt einer Datei anzeigen zu lassen, kann man beospielsweise den Befehl cat PFAD_ZUR_DATEI nutzen.</p>"


@app.route("/command_injection_1_hint4", methods=["POST"])
def command_injection_1_hint4():
    if request.form["hint4"]:
        return "<p>Die Ausgabe zeigt nach dem Input noch weiteren Text an.<br>Dieser wird an unseren injizierten Befehl drangehängt.</p>"


@app.route("/command_injection_1_hint5", methods=["POST"])
def command_injection_1_hint5():
    if request.form["hint5"]:
        return "<p>Man kann den angehängten Text auskommentieren, indem man seine Eingabe mit einem # beendet. <br>Es sollte einen whitespace zum voherigen Zeichen haben.</p>"


@app.route("/command_injection_1_hint6", methods=["POST"])
def command_injection_1_hint6():
    if request.form["hint6"]:
        return "<p>Eine Mögliche Lösung lautet:<br>;cat ~/passwordLVL1.txt #<br>Erklärung:<br>; bricht echo ab.<br>cat ~/passwordLVL1.txt zeigt den Inhalt der Datei an.<br> whitespace # sorgt dafür, dass der angehängt Text auskommentiert wird und der Befehl legitim ist.</p>"


if __name__ == "__main__":
    app.run(host="0.0.0.0")
